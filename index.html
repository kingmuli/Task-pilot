<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TaskPilot - Premium Weekly Routine Planner</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#0a0a0a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TaskPilot">
  <meta name="description" content="Plan your week with smart timers, notes, and customizable rewards">
  <meta name="keywords" content="routine, planner, timer, tasks, productivity, notes">
  
  <!-- Manifest Link -->
  <link rel="manifest" href="/manifest.json">
   
  <!-- Additional PWA Meta Tags -->
  <meta name="application-name" content="TaskPilot">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-config" content="/browserconfig.xml">
  <meta name="msapplication-TileColor" content="#0a0a0a">
  <meta name="msapplication-TileImage" content="/icons/icon-144x144.png">
  <meta name="msapplication-tap-highlight" content="no">

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/icons/icon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png">

  <!-- Microsoft Tile Images -->
  <meta name="msapplication-square70x70logo" content="/icons/icon-72x72.png">
  <meta name="msapplication-square150x150logo" content="/icons/icon-150x150.png">
  <meta name="msapplication-wide310x150logo" content="/icons/icon-310x150.png">
  <meta name="msapplication-square310x310logo" content="/icons/icon-310x310.png">

  <!-- Favicon for legacy browsers -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="shortcut icon" href="/favicon.ico">

  <!-- Styles & Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --black: #0a0a0a;
      --dark-gray: #1a1a1a;
      --gray: #2a2a2a;
      --light-gray: #3a3a3a;
      --gold: #ffd700;
      --gold-hover: #ffed4e;
      --white: #ffffff;
      --off-white: #f0f0f0;
      --muted: #888888;
      --accent: #00d4ff;
      --accent-dark: #00a8cc;
      --success: #00ff88;
      --error: #ff4d4d;
      --shadow: rgba(0, 0, 0, 0.3);
      --glow: rgba(255, 215, 0, 0.3);
      
      --font-primary: 'Inter', sans-serif;
      --font-heading: 'Space Grotesk', sans-serif;
      
      --border-radius: 12px;
      --border-radius-large: 20px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Custom reward colors */
      --reward-primary: #ffd700;
      --reward-secondary: #ffed4e;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-primary);
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--off-white);
      transition: background 1.5s ease;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
      z-index: -1;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .glass-card {
      background: rgba(42, 42, 42, 0.7);
      backdrop-filter: blur(15px);
      border-radius: var(--border-radius-large);
      box-shadow: 0 8px 32px var(--shadow);
      padding: 24px;
      margin-bottom: 20px;
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    }

    .glass-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    }

    header {
      text-align: center;
      margin-bottom: 24px;
      background: rgba(10, 10, 10, 0.9);
      color: var(--white);
      padding: 30px 20px;
      border-radius: var(--border-radius-large);
      box-shadow: 0 8px 32px var(--shadow);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--gold));
    }

    .logo-container {
      text-align: center;
      margin-bottom: 10px;
    }

    .logo {
      font-family: var(--font-heading);
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent), var(--gold));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 5px;
    }

    .subtitle {
      color: var(--muted);
      font-size: 1.1rem;
      opacity: 0.9;
      max-width: 600px;
      margin: 0 auto;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .dashboard-card {
      background: rgba(42, 42, 42, 0.7);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: 0 4px 16px var(--shadow);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: var(--transition);
    }

    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .card-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(0, 212, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      color: var(--accent);
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .card-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .card-label {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .week-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      background: rgba(58, 58, 58, 0.5);
      padding: 15px 20px;
      border-radius: var(--border-radius);
      font-weight: 500;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .timer-info {
      background: rgba(58, 58, 58, 0.7);
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 20px;
      border-left: 4px solid var(--accent);
      position: relative;
    }

    .timer-display {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 5px;
    }

    .current-time {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .tabs {
      display: flex;
      background: rgba(58, 58, 58, 0.5);
      border-radius: 50px;
      padding: 6px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px var(--shadow);
      overflow-x: auto;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 12px 0;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
      color: var(--muted);
      min-width: 80px;
      position: relative;
    }

    .tab.active {
      background: var(--accent);
      color: var(--black);
      box-shadow: 0 2px 8px rgba(0, 212, 255, 0.4);
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 3px;
      background: var(--gold);
      border-radius: 2px;
    }

    .task-input-container {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .time-input, .text-input, .date-input {
      padding: 14px 16px;
      border: 1px solid var(--light-gray);
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
      background: var(--dark-gray);
      color: var(--off-white);
    }

    .time-input {
      flex: 0 0 120px;
    }

    .date-input {
      flex: 0 0 150px;
    }

    .text-input {
      flex: 1;
      min-width: 200px;
    }

    .time-input:focus, .text-input:focus, .date-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }

    .add-btn {
      background: var(--accent);
      color: var(--black);
      border: none;
      border-radius: var(--border-radius);
      padding: 0 24px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      height: 50px;
    }

    .add-btn:hover {
      background: var(--gold);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
    }

    .task-list {
      list-style: none;
    }

    .task-item {
      background: var(--dark-gray);
      border-radius: var(--border-radius);
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      box-shadow: 0 4px 12px var(--shadow);
      transition: var(--transition);
      border-left: 4px solid var(--accent);
      position: relative;
      overflow: hidden;
    }

    .task-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    .task-item.done {
      opacity: 0.7;
      border-left-color: var(--success);
    }

    .task-item.has-timer {
      border-left-color: var(--gold);
    }

    .task-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    }

    .task-checkbox {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid var(--light-gray);
      margin-right: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      position: relative;
    }

    .task-checkbox.checked {
      background: var(--success);
      border-color: var(--success);
    }

    .task-checkbox.checked::after {
      content: '‚úì';
      color: var(--black);
      font-size: 12px;
      font-weight: bold;
    }

    .task-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .task-time {
      font-weight: 600;
      color: var(--accent);
      font-size: 0.9rem;
    }

    .task-text {
      font-size: 1rem;
      color: var(--off-white);
    }

    .task-text.done {
      text-decoration: line-through;
      color: var(--muted);
    }

    .task-timer {
      font-size: 0.8rem;
      color: var(--gold);
      margin-top: 4px;
      font-weight: 500;
    }

    .task-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .timer-btn {
      background: var(--light-gray);
      color: var(--muted);
    }

    .timer-btn:hover {
      background: var(--gold);
      color: var(--black);
    }

    .timer-btn.active {
      background: var(--gold);
      color: var(--black);
    }

    .edit-btn {
      background: var(--light-gray);
      color: var(--muted);
    }

    .edit-btn:hover {
      background: var(--accent);
      color: var(--black);
    }

    .delete-btn {
      background: var(--light-gray);
      color: var(--muted);
    }

    .delete-btn:hover {
      background: #ff4d4d;
      color: var(--white);
    }

    .rewards-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: var(--black);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 32px var(--shadow);
      margin-top: 20px;
      position: relative;
      overflow: hidden;
    }

    .rewards-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    }

    .reward-item {
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .reward-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .reward-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    .empty-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .progress-bar {
      height: 6px;
      background: var(--light-gray);
      border-radius: 3px;
      margin: 20px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--success);
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .reset-notice {
      background: rgba(58, 58, 58, 0.7);
      border-radius: var(--border-radius);
      padding: 10px 15px;
      margin-bottom: 15px;
      font-size: 0.9rem;
      color: var(--off-white);
      text-align: center;
      border-left: 4px solid var(--gold);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: var(--dark-gray);
      padding: 30px;
      border-radius: var(--border-radius-large);
      box-shadow: 0 8px 32px var(--shadow);
      max-width: 500px;
      width: 90%;
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }

    .modal h3 {
      margin-bottom: 15px;
      color: var(--accent);
      font-size: 1.5rem;
    }

    .modal p {
      color: var(--off-white);
      margin-bottom: 20px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    .modal-btn.confirm {
      background: var(--accent);
      color: var(--black);
    }

    .modal-btn.cancel {
      background: var(--light-gray);
      color: var(--off-white);
    }

    /* Notes Section */
    .notes-section {
      margin-top: 30px;
    }

    .notes-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .notes-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--accent);
    }

    .notes-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }

    .note-card {
      background: var(--dark-gray);
      border-radius: var(--border-radius);
      padding: 15px;
      box-shadow: 0 4px 12px var(--shadow);
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.05);
      position: relative;
    }

    .note-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    .note-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .note-title {
      font-weight: 600;
      color: var(--off-white);
      font-size: 1rem;
    }

    .note-date {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .note-content {
      color: var(--off-white);
      font-size: 0.9rem;
      line-height: 1.4;
      max-height: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .note-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .note-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      background: var(--light-gray);
      color: var(--muted);
    }

    .note-btn:hover {
      background: var(--accent);
      color: var(--black);
    }

    .add-note-btn {
      background: var(--gold);
      color: var(--black);
      border: none;
      border-radius: var(--border-radius);
      padding: 10px 15px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .add-note-btn:hover {
      background: var(--gold-hover);
      transform: translateY(-2px);
    }

    .note-modal {
      display: none;
    }

    .note-modal-content {
      max-width: 600px;
    }

    .note-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .note-input, .note-textarea {
      padding: 12px;
      border: 1px solid var(--light-gray);
      border-radius: var(--border-radius);
      font-size: 1rem;
      background: var(--gray);
      color: var(--off-white);
      transition: var(--transition);
    }

    .note-input:focus, .note-textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }

    .note-textarea {
      min-height: 150px;
      resize: vertical;
    }

    /* Streak Counter Styles */
    .streak-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      background: rgba(58, 58, 58, 0.7);
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      position: relative;
      overflow: hidden;
    }

    .streak-flame {
      font-size: 2.5rem;
      color: var(--gold);
      animation: flameGlow 2s infinite alternate;
      filter: drop-shadow(0 0 10px var(--gold));
    }

    @keyframes flameGlow {
      0% {
        transform: scale(1);
        filter: drop-shadow(0 0 5px var(--gold));
      }
      100% {
        transform: scale(1.1);
        filter: drop-shadow(0 0 15px var(--gold));
      }
    }

    .streak-info {
      text-align: center;
    }

    .streak-count {
      font-size: 2rem;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 5px;
    }

    .streak-label {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .streak-subtitle {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 5px;
    }

    /* Affirmation Styles */
    .affirmation-container {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: var(--black);
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .affirmation-icon {
      font-size: 1.5rem;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    .affirmation-text {
      font-size: 1.1rem;
      font-weight: 500;
      font-style: italic;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .affirmation-author {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .refresh-affirmation {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.2);
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      color: var(--black);
      cursor: pointer;
      transition: var(--transition);
    }

    .refresh-affirmation:hover {
      background: rgba(0, 0, 0, 0.3);
      transform: rotate(90deg);
    }

    /* Reward Customization Styles */
    .reward-settings {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--accent);
      color: var(--black);
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      cursor: pointer;
      box-shadow: 0 4px 12px var(--shadow);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      font-size: 1.5rem;
    }

    .reward-settings:hover {
      background: var(--gold);
      transform: scale(1.1);
    }

    .reward-modal {
      display: none;
    }

    .reward-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      border-radius: var(--border-radius);
      background: var(--gray);
      margin-bottom: 10px;
      cursor: pointer;
      transition: var(--transition);
    }

    .reward-option:hover {
      background: var(--light-gray);
    }

    .reward-option.selected {
      background: rgba(0, 212, 255, 0.2);
      border: 1px solid var(--accent);
    }

    .reward-icon {
      font-size: 1.5rem;
      width: 40px;
      text-align: center;
    }

    .reward-details {
      flex: 1;
    }

    .reward-name {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .reward-description {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .currency-select {
      padding: 10px;
      border-radius: var(--border-radius);
      background: var(--gray);
      border: 1px solid var(--light-gray);
      color: var(--off-white);
      width: 100%;
      margin-top: 10px;
    }

    .custom-reward-input {
      padding: 10px;
      border-radius: var(--border-radius);
      background: var(--gray);
      border: 1px solid var(--light-gray);
      color: var(--off-white);
      width: 100%;
      margin-top: 10px;
    }
    .widget-btn {
  position: fixed;
  bottom: 80px;
  right: 20px;
  background: var(--secondary);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 12px 20px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: var(--shadow);
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 8px;
}

@media (display-mode: standalone) {
  .widget-btn {
    display: flex !important;
  }
}

    /* PWA-specific styles */
    .install-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--accent);
      color: var(--black);
      border: none;
      border-radius: 50px;
      padding: 12px 20px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px var(--shadow);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
    }

    .install-btn:hover {
      background: var(--gold);
      transform: translateY(-2px);
    }

    .offline-message {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--gold);
      color: var(--black);
      text-align: center;
      padding: 10px;
      z-index: 1001;
      display: none;
      font-weight: 600;
    }

    /* Animations */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .slide-in {
      animation: slideIn 0.5s ease-out;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .task-input-container {
        flex-direction: column;
      }
      
      .tabs {
        flex-wrap: wrap;
      }
      
      .tab {
        flex: 0 0 calc(25% - 8px);
        margin: 4px;
        font-size: 0.9rem;
      }
      
      .rewards-container, .stats-container, .notes-container {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .week-info {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
      
      .time-input, .date-input, .text-input {
        width: 100%;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .reward-settings {
        bottom: 80px;
        left: 20px;
      }
    }

    @media (display-mode: standalone) {
      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }
      
      .install-btn {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- Offline Indicator -->
  <div class="offline-message" id="offlineMessage">
    <i class="fas fa-wifi"></i> You are currently offline
  </div>

  <!-- Install Button -->
  <button class="install-btn" id="installButton">
    <i class="fas fa-download"></i> Install App
  </button>

  <!-- Reward Settings Button -->
  <button class="reward-settings" id="rewardSettings">
    <i class="fas fa-gift"></i>
  </button>

  <div class="container">
    <header>
      <div class="logo-container">
        <div class="logo">TaskPilot</div>
      </div>
      <p class="subtitle">Plan your week, set timers, take notes, track progress, and earn customizable rewards</p>
    </header>
    
    <div class="dashboard-grid">
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon">
            <i class="fas fa-fire"></i>
          </div>
          <div class="card-title">Current Streak</div>
        </div>
        <div class="card-value" id="streakCount">0</div>
        <div class="card-label" id="streakSubtitle">Keep going!</div>
      </div>
      
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon">
            <i class="fas fa-tasks"></i>
          </div>
          <div class="card-title">Weekly Progress</div>
        </div>
        <div class="card-value" id="completionRate">0%</div>
        <div class="card-label"><span id="completedTasks">0</span> of <span id="weeklyTasks">0</span> tasks completed</div>
      </div>
      
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon">
            <i class="fas fa-star"></i>
          </div>
          <div class="card-title">Total Rewards</div>
        </div>
        <div class="card-value" id="starCount">0</div>
        <div class="card-label" id="rewardLabel">Stars earned</div>
      </div>
    </div>

    <div class="glass-card">
      <div class="timer-info">
        <div class="timer-display" id="timerDisplay">No active timers</div>
        <div class="current-time" id="currentTime">Loading current time...</div>
      </div>

      <div class="week-info">
        <div>Current Week: <span id="currentWeek">Loading...</span></div>
        <div>Next Reset: <span id="nextReset">Loading...</span></div>
      </div>

      <div class="reset-notice">
        <i class="fas fa-info-circle"></i> Tasks reset every Monday, but your rewards, notes, and streak are permanent!
      </div>

      <div class="affirmation-container" id="affirmationContainer">
        <button class="refresh-affirmation" id="refreshAffirmation">
          <i class="fas fa-redo"></i>
        </button>
        <div class="affirmation-icon">
          <i class="fas fa-quote-left"></i>
        </div>
        <div class="affirmation-text" id="affirmationText">Loading daily affirmation...</div>
        <div class="affirmation-author" id="affirmationAuthor"></div>
      </div>

      <div class="tabs">
        <div class="tab active" data-day="Monday">Mon</div>
        <div class="tab" data-day="Tuesday">Tue</div>
        <div class="tab" data-day="Wednesday">Wed</div>
        <div class="tab" data-day="Thursday">Thu</div>
        <div class="tab" data-day="Friday">Fri</div>
        <div class="tab" data-day="Saturday">Sat</div>
        <div class="tab" data-day="Sunday">Sun</div>
      </div>

      <div class="task-input-container">
        <input type="date" class="date-input" id="taskDate">
        <input type="time" class="time-input" id="taskTime">
        <input type="text" class="text-input" id="taskText" placeholder="What do you need to do?">
        <button class="add-btn" id="addTask">
          <i class="fas fa-plus"></i> Add
        </button>
      </div>

      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <ul class="task-list" id="taskList">
        <!-- Tasks will be dynamically inserted here -->
      </ul>
    </div>

    <!-- Notes Section -->
    <div class="glass-card notes-section">
      <div class="notes-header">
        <h2 class="notes-title"><i class="fas fa-sticky-note"></i> Notes</h2>
        <button class="add-note-btn" id="addNoteBtn">
          <i class="fas fa-plus"></i> Add Note
        </button>
      </div>
      <div class="notes-container" id="notesContainer">
        <!-- Notes will be dynamically inserted here -->
      </div>
    </div>

    <div class="rewards-container">
      <div class="reward-item">
        <div class="reward-value" id="totalRewards">0</div>
        <div class="reward-label">Total Rewards</div>
      </div>
      <div class="reward-item">
        <div class="reward-value" id="weeklyRewards">0</div>
        <div class="reward-label">This Week</div>
      </div>
      <div class="reward-item">
        <div class="reward-value" id="rewardValue">0</div>
        <div class="reward-label" id="rewardUnit">Units</div>
      </div>
    </div>
  </div>

  <!-- Timer Alert Modal -->
  <div class="modal" id="timerModal">
    <div class="modal-content">
      <h3><i class="fas fa-bell"></i> Timer Alert!</h3>
      <p id="timerMessage">Time's up for your task!</p>
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="snoozeTimer">Snooze (5 min)</button>
        <button class="modal-btn confirm" id="dismissTimer">Dismiss</button>
      </div>
    </div>
  </div>

  <!-- Note Modal -->
  <div class="modal note-modal" id="noteModal">
    <div class="modal-content note-modal-content">
      <h3><i class="fas fa-sticky-note"></i> <span id="noteModalTitle">Add New Note</span></h3>
      <div class="note-form">
        <input type="text" class="note-input" id="noteTitle" placeholder="Note Title">
        <textarea class="note-textarea" id="noteContent" placeholder="Write your note here..."></textarea>
        <div class="modal-buttons">
          <button class="modal-btn cancel" id="cancelNote">Cancel</button>
          <button class="modal-btn confirm" id="saveNote">Save Note</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reward Customization Modal -->
  <div class="modal reward-modal" id="rewardModal">
    <div class="modal-content">
      <h3><i class="fas fa-gift"></i> Customize Your Rewards</h3>
      <p>Choose how you want to be rewarded for completing tasks:</p>
      
      <div class="reward-option" data-type="stars">
        <div class="reward-icon">‚≠ê</div>
        <div class="reward-details">
          <div class="reward-name">Stars</div>
          <div class="reward-description">Classic star-based reward system</div>
        </div>
      </div>
      
      <div class="reward-option" data-type="money">
        <div class="reward-icon">üí∞</div>
        <div class="reward-details">
          <div class="reward-name">Money</div>
          <div class="reward-description">Earn virtual money with real currency values</div>
        </div>
        <select class="currency-select" id="currencySelect" style="display: none;">
          <option value="USD">USD ($)</option>
          <option value="EUR">EUR (‚Ç¨)</option>
          <option value="GBP">GBP (¬£)</option>
          <option value="JPY">JPY (¬•)</option>
          <option value="KES">KES (KSh)</option>
          <option value="custom">Custom Currency</option>
        </select>
      </div>
      
      <div class="reward-option" data-type="bananas">
        <div class="reward-icon">üçå</div>
        <div class="reward-details">
          <div class="reward-name">Bananas</div>
          <div class="reward-description">Fun and fruity reward system</div>
        </div>
      </div>
      
      <div class="reward-option" data-type="custom">
        <div class="reward-icon">‚ú®</div>
        <div class="reward-details">
          <div class="reward-name">Custom</div>
          <div class="reward-description">Create your own reward system</div>
        </div>
        <input type="text" class="custom-reward-input" id="customRewardInput" placeholder="Enter your reward unit (e.g., points, coins)" style="display: none;">
      </div>
      
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="cancelReward">Cancel</button>
        <button class="modal-btn confirm" id="saveReward">Save Preferences</button>
      </div>
    </div>
  </div>

  <button onclick="installWidget()" class="widget-btn" style="display: none;">
  <i class="fas fa-plus-square"></i> Add Widget
</button>

  <!-- Widget Templates -->
<script type="application/json" id="widget-today">
{
  "widget": {
    "name": "Today's Tasks",
    "description": "Your tasks for today",
    "template": "grid",
    "data": {
      "items": []
    }
  }
}
</script>

<script type="application/json" id="widget-progress">
{
  "widget": {
    "name": "Weekly Progress", 
    "description": "Your completion progress",
    "template": "value",
    "data": {
      "value": 0,
      "max": 100,
      "unit": "%"
    }
  }
}
</script>

  <script>
    // PWA Installation and Core Variables
    let deferredPrompt;
    let currentDay = "Monday";
    let currentWeek = getCurrentWeek();
    let activeTimers = {};
    let timerInterval;
    let bgIndex = 0;
    let editingNoteId = null;
    let currentStreak = 0;
    let dailyAffirmations = [];
    let currentAffirmationIndex = 0;
    
    // Reward System Variables
    let rewardType = "stars"; // Default reward type
    let rewardUnit = "Stars";
    let currency = "USD";
    let customRewardName = "";
    let rewardValue = 0; // Value per completed task

    // DOM Elements
    const installButton = document.getElementById('installButton');
    const offlineMessage = document.getElementById('offlineMessage');
    const taskDateInput = document.getElementById('taskDate');
    const taskTimeInput = document.getElementById('taskTime');
    const taskTextInput = document.getElementById('taskText');
    const addTaskBtn = document.getElementById('addTask');
    const taskList = document.getElementById('taskList');
    const tabs = document.querySelectorAll('.tab');
    const starCount = document.getElementById('starCount');
    const totalRewards = document.getElementById('totalRewards');
    const weeklyRewards = document.getElementById('weeklyRewards');
    const rewardValueElem = document.getElementById('rewardValue');
    const rewardUnitElem = document.getElementById('rewardUnit');
    const rewardLabel = document.getElementById('rewardLabel');
    const progressFill = document.getElementById('progressFill');
    const currentWeekElem = document.getElementById('currentWeek');
    const nextResetElem = document.getElementById('nextReset');
    const weeklyTasksElem = document.getElementById('weeklyTasks');
    const completedTasksElem = document.getElementById('completedTasks');
    const completionRateElem = document.getElementById('completionRate');
    const timerDisplay = document.getElementById('timerDisplay');
    const currentTimeElem = document.getElementById('currentTime');
    const timerModal = document.getElementById('timerModal');
    const timerMessage = document.getElementById('timerMessage');
    const snoozeTimerBtn = document.getElementById('snoozeTimer');
    const dismissTimerBtn = document.getElementById('dismissTimer');
    
    // Notes elements
    const addNoteBtn = document.getElementById('addNoteBtn');
    const notesContainer = document.getElementById('notesContainer');
    const noteModal = document.getElementById('noteModal');
    const noteModalTitle = document.getElementById('noteModalTitle');
    const noteTitleInput = document.getElementById('noteTitle');
    const noteContentInput = document.getElementById('noteContent');
    const saveNoteBtn = document.getElementById('saveNote');
    const cancelNoteBtn = document.getElementById('cancelNote');
    
    // Reward elements
    const rewardSettings = document.getElementById('rewardSettings');
    const rewardModal = document.getElementById('rewardModal');
    const rewardOptions = document.querySelectorAll('.reward-option');
    const currencySelect = document.getElementById('currencySelect');
    const customRewardInput = document.getElementById('customRewardInput');
    const saveRewardBtn = document.getElementById('saveReward');
    const cancelRewardBtn = document.getElementById('cancelReward');
    // ============ PWA INSTALLATION HANDLER ============
class PWAInstaller {
  constructor() {
    this.deferredPrompt = null;
    this.installButton = document.getElementById('installButton');
    this.init();
  }

  init() {
    // Listen for beforeinstallprompt event
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      this.deferredPrompt = e;
      this.showInstallPromotion();
    });

    // Listen for app installed event
    window.addEventListener('appinstalled', () => {
      console.log('TaskPilot was installed successfully');
      this.hideInstallPromotion();
      this.logInstallation();
    });

    // Install button click handler
    if (this.installButton) {
      this.installButton.addEventListener('click', () => {
        this.installApp();
      });
    }

    // Check if app is already installed
    this.checkInstallStatus();
  }

  showInstallPromotion() {
    if (this.installButton && !this.isRunningStandalone()) {
      this.installButton.style.display = 'flex';
      this.installButton.classList.add('pulse');
      
      // Auto-hide after 10 seconds
      setTimeout(() => {
        this.hideInstallPromotion();
      }, 10000);
    }
  }

  hideInstallPromotion() {
    if (this.installButton) {
      this.installButton.style.display = 'none';
      this.installButton.classList.remove('pulse');
    }
  }

  async installApp() {
    if (!this.deferredPrompt) {
      alert('TaskPilot can be installed from your browser menu!');
      return;
    }

    this.deferredPrompt.prompt();
    const { outcome } = await this.deferredPrompt.userChoice;
    
    if (outcome === 'accepted') {
      console.log('User accepted the install prompt');
      this.hideInstallPromotion();
    }
    
    this.deferredPrompt = null;
  }

  isRunningStandalone() {
    return window.matchMedia('(display-mode: standalone)').matches || 
           window.navigator.standalone === true;
  }

  checkInstallStatus() {
    if (this.isRunningStandalone()) {
      this.hideInstallPromotion();
      console.log('App is running in standalone mode');
    }
  }

  logInstallation() {
    // Send installation analytics (optional)
    if (navigator.sendBeacon) {
      const data = new FormData();
      data.append('type', 'installation');
      data.append('timestamp', new Date().toISOString());
      navigator.sendBeacon('/api/analytics', data);
    }
  }
}

// ============ NETWORK MANAGER ============
class NetworkManager {
  constructor() {
    this.online = navigator.onLine;
    this.retryCount = 0;
    this.maxRetries = 3;
    this.init();
  }

  init() {
    window.addEventListener('online', () => this.handleOnline());
    window.addEventListener('offline', () => this.handleOffline());
    
    // Initial check
    if (!this.online) {
      this.handleOffline();
    }
  }

  handleOnline() {
    this.online = true;
    this.retryCount = 0;
    const offlineMessage = document.getElementById('offlineMessage');
    if (offlineMessage) offlineMessage.style.display = 'none';
    console.log('Connection restored');
    
    // Retry any pending operations
    this.retryPendingOperations();
  }

  handleOffline() {
    this.online = false;
    const offlineMessage = document.getElementById('offlineMessage');
    if (offlineMessage) offlineMessage.style.display = 'block';
    console.log('Connection lost');
  }

  async retryPendingOperations() {
    try {
      await this.syncPendingData();
      console.log('Pending data synced successfully');
    } catch (error) {
      console.error('Failed to sync pending data:', error);
    }
  }

  async syncPendingData() {
    // Sync tasks, notes, etc.
    return Promise.all([
      this.syncTasks(),
      this.syncNotes(),
      this.syncSettings()
    ]);
  }

  async syncTasks() {
    // Implementation for syncing tasks
    console.log('Syncing tasks...');
  }

  async syncNotes() {
    // Implementation for syncing notes
    console.log('Syncing notes...');
  }

  async syncSettings() {
    // Implementation for syncing settings
    console.log('Syncing settings...');
  }
}

    // Initialize data structure
    let appData = JSON.parse(localStorage.getItem("taskpilotData"));
    if (!appData || appData.currentWeek !== currentWeek) {
        appData = {
            currentWeek: currentWeek,
            routine: {
                Monday: [], Tuesday: [], Wednesday: [],
                Thursday: [], Friday: [], Saturday: [], Sunday: []
            },
            notes: [],
            totalRewards: appData ? appData.totalRewards : 0,
            weeklyRewards: 0,
            lastReset: new Date().toISOString(),
            timers: {},
            rewardType: "stars",
            rewardUnit: "Stars",
            currency: "USD",
            customRewardName: "",
            currentStreak: 0,
            lastCompletionDate: null
        };
    }

    // Load reward preferences
    if (appData.rewardType) {
        rewardType = appData.rewardType;
        rewardUnit = appData.rewardUnit;
        currency = appData.currency;
        customRewardName = appData.customRewardName;
    }

    let routine = appData.routine;
    let notes = appData.notes;
    let totalRewardsValue = appData.totalRewards;
    let weeklyRewardsValue = appData.weeklyRewards;

    // Background slideshow
    const backgrounds = [
        "linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%)",
        "linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%)",
        "linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%)",
        "linear-gradient(135deg, #0a0a0a 0%, #2a2a2a 100%)",
        "linear-gradient(135deg, #1a1a1a 0%, #3a3a3a 100%)"
    ];

    // ============ UTILITY FUNCTIONS ============
    function getCurrentWeek() {
        const now = new Date();
        const startOfYear = new Date(now.getFullYear(), 0, 1);
        const diff = now - startOfYear;
        const oneWeek = 1000 * 60 * 60 * 24 * 7;
        return Math.floor(diff / oneWeek);
    }

    function getNextResetDate() {
        const now = new Date();
        const daysUntilMonday = (8 - now.getDay()) % 7;
        const nextMonday = new Date(now);
        nextMonday.setDate(now.getDate() + daysUntilMonday);
        nextMonday.setHours(0, 0, 0, 0);
        return nextMonday;
    }

    function formatDate(date) {
        return date.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    }

    function formatTime(date) {
        return date.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
    }

    function formatNoteDate(date) {
        return date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric',
            year: 'numeric'
        });
    }

    function changeBackground() {
        document.body.style.background = backgrounds[bgIndex];
        bgIndex = (bgIndex + 1) % backgrounds.length;
    }

    // ============ REWARD SYSTEM FUNCTIONS ============
    function updateRewardDisplay() {
        // Update the main display
        totalRewards.textContent = totalRewardsValue;
        weeklyRewards.textContent = weeklyRewardsValue;
        
        // Update based on reward type
        switch(rewardType) {
            case "stars":
                rewardValueElem.textContent = totalRewardsValue;
                rewardUnitElem.textContent = rewardUnit;
                rewardLabel.textContent = `${rewardUnit} earned`;
                rewardValue = 1; // 1 star per task
                break;
            case "money":
                // Convert to selected currency
                const conversionRates = {
                    "USD": 1,
                    "EUR": 0.85,
                    "GBP": 0.73,
                    "JPY": 110,
                    "KES": 110,
                    "custom": 1
                };
                
                const rate = conversionRates[currency] || 1;
                const moneyValue = totalRewardsValue * rate;
                
                // Format based on currency
                let formattedValue;
                if (currency === "USD") formattedValue = `$${moneyValue.toFixed(2)}`;
                else if (currency === "EUR") formattedValue = `‚Ç¨${moneyValue.toFixed(2)}`;
                else if (currency === "GBP") formattedValue = `¬£${moneyValue.toFixed(2)}`;
                else if (currency === "JPY") formattedValue = `¬•${Math.round(moneyValue)}`;
                else if (currency === "KES") formattedValue = `KSh ${moneyValue.toFixed(2)}`;
                else formattedValue = `${moneyValue} ${currency}`;
                
                rewardValueElem.textContent = formattedValue;
                rewardUnitElem.textContent = currency === "custom" ? customRewardName : currency;
                rewardLabel.textContent = `${currency === "custom" ? customRewardName : currency} earned`;
                rewardValue = 1; // $1 per task (converted to selected currency)
                break;
            case "bananas":
                rewardValueElem.textContent = totalRewardsValue;
                rewardUnitElem.textContent = "üçå";
                rewardLabel.textContent = "Bananas earned";
                rewardValue = 1; // 1 banana per task
                break;
            case "custom":
                rewardValueElem.textContent = totalRewardsValue;
                rewardUnitElem.textContent = customRewardName || "Units";
                rewardLabel.textContent = `${customRewardName || "Units"} earned`;
                rewardValue = 1; // 1 unit per task
                break;
        }
    }

    function openRewardModal() {
        // Set current selection
        rewardOptions.forEach(option => {
            if (option.dataset.type === rewardType) {
                option.classList.add('selected');
                
                // Show additional inputs if needed
                if (rewardType === "money") {
                    currencySelect.style.display = 'block';
                    currencySelect.value = currency;
                } else if (rewardType === "custom") {
                    customRewardInput.style.display = 'block';
                    customRewardInput.value = customRewardName;
                }
            } else {
                option.classList.remove('selected');
            }
        });
        
        rewardModal.style.display = 'flex';
    }

    function closeRewardModal() {
        rewardModal.style.display = 'none';
        // Hide additional inputs
        currencySelect.style.display = 'none';
        customRewardInput.style.display = 'none';
    }

    function saveRewardPreferences() {
        // Get selected reward type
        const selectedOption = document.querySelector('.reward-option.selected');
        if (!selectedOption) return;
        
        rewardType = selectedOption.dataset.type;
        
        // Get additional settings based on type
        if (rewardType === "money") {
            currency = currencySelect.value;
            if (currency === "custom") {
                const customCurrency = prompt("Enter your custom currency symbol or name:");
                if (customCurrency) currency = customCurrency;
            }
            rewardUnit = currency;
        } else if (rewardType === "custom") {
            customRewardName = customRewardInput.value.trim() || "Units";
            rewardUnit = customRewardName;
        } else {
            rewardUnit = rewardType === "stars" ? "Stars" : "üçå";
        }
        
        // Save to app data
        appData.rewardType = rewardType;
        appData.rewardUnit = rewardUnit;
        appData.currency = currency;
        appData.customRewardName = customRewardName;
        
        saveData();
        updateRewardDisplay();
        closeRewardModal();
        
        // Show confirmation
        showNotification('üéâ Reward System Updated', `You're now earning ${rewardUnit} for completed tasks!`);
    }

    // Widget API endpoints
if ('serviceWorker' in navigator) {
  // Mock API endpoints for widgets
  navigator.serviceWorker.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'widget-data') {
      const response = handleWidgetRequest(event.data);
      event.ports[0].postMessage(response);
    }
  });
}

function handleWidgetRequest(request) {
  switch (request.url) {
    case '/api/widget/today':
      return getTodayTasksData();
    case '/api/widget/progress':
      return getProgressData();
    default:
      return { error: 'Not found' };
  }
}

function getTodayTasksData() {
  const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
  const todayTasks = routine[today] || [];
  
  return {
    items: todayTasks.slice(0, 5).map(task => ({
      title: task.text,
      subtitle: task.time,
      completed: task.done,
      badge: task.done ? '‚úÖ' : '‚è∞'
    }))
  };
}

function getProgressData() {
  let completed = 0;
  let total = 0;
  
  Object.values(routine).forEach(dayTasks => {
    dayTasks.forEach(task => {
      total++;
      if (task.done) completed++;
    });
  });
  
  const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
  
  return {
    value: progress,
    max: 100,
    unit: "%",
    label: "Weekly Progress",
    color: progress > 70 ? "green" : progress > 40 ? "orange" : "red"
  };
}

// Widget installation prompt
function installWidget() {
  if ('serviceWorker' in navigator && 'widgets' in navigator) {
    navigator.widgets.register({
      name: 'Today\'s Tasks',
      template: 'grid',
      tag: 'today-tasks'
    }).then(() => {
      alert('Widget installed! Check your home screen.');
    }).catch(error => {
      console.log('Widget installation failed:', error);
    });
  } else {
    alert('Widgets not supported in this browser');
  }
}

// Update widget data periodically
setInterval(() => {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.ready.then(registration => {
      registration.active.postMessage({
        type: 'update-widgets',
        data: {
          today: getTodayTasksData(),
          progress: getProgressData()
        }
      });
    });
  }
}, 30000); // Update every 30 seconds

    // ============ STREAK MANAGEMENT ============
    function calculateStreak() {
        const today = new Date().toDateString();
        const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toDateString();
        
        // Check if we have streak data
        if (!appData.lastCompletionDate) {
            currentStreak = 0;
            return;
        }
        
        // Check if yesterday was completed
        if (appData.lastCompletionDate === yesterday || 
            (appData.lastCompletionDate === today && new Date().getHours() < 6)) {
            currentStreak = (appData.currentStreak || 0) + 1;
        } else if (appData.lastCompletionDate === today) {
            currentStreak = appData.currentStreak || 0;
        } else {
            currentStreak = 0;
        }
        
        appData.currentStreak = currentStreak;
        appData.lastCompletionDate = today;
    }

    function updateStreakDisplay() {
        document.getElementById('streakCount').textContent = currentStreak;
        
        const subtitle = document.getElementById('streakSubtitle');
        if (currentStreak === 0) {
            subtitle.textContent = 'Start your streak!';
        } else if (currentStreak < 3) {
            subtitle.textContent = 'Good start!';
        } else if (currentStreak < 7) {
            subtitle.textContent = 'Building momentum!';
        } else if (currentStreak < 14) {
            subtitle.textContent = 'On fire!';
        } else if (currentStreak < 30) {
            subtitle.textContent = 'Unstoppable!';
        } else {
            subtitle.textContent = 'Legendary!';
        }
    }

    function checkDailyCompletion() {
        const today = new Date().toDateString();
        let dailyCompleted = true;
        
        // Check if all tasks for today are completed
        const dayName = new Date().toLocaleDateString('en-US', { weekday: 'long' });
        const todayTasks = routine[dayName] || [];
        
        if (todayTasks.length === 0) {
            dailyCompleted = false;
        } else {
            dailyCompleted = todayTasks.every(task => task.done);
        }
        
        if (dailyCompleted) {
            if (appData.lastCompletionDate !== today) {
                currentStreak++;
                appData.currentStreak = currentStreak;
                appData.lastCompletionDate = today;
                saveData();
                
                // Show streak celebration for streaks > 0
                if (currentStreak > 1) {
                    showNotification('üî• Streak Updated!', `You're on a ${currentStreak}-day streak!`);
                }
            }
        } else {
            // Check if we need to break the streak (after midnight)
            if (appData.lastCompletionDate && appData.lastCompletionDate !== today) {
                const lastDate = new Date(appData.lastCompletionDate);
                const daysSince = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysSince > 1 && currentStreak > 0) {
                    showNotification('üíî Streak Broken', `Your ${currentStreak}-day streak has ended.`);
                    currentStreak = 0;
                    appData.currentStreak = 0;
                    saveData();
                }
            }
        }
        
        updateStreakDisplay();
    }

    // ============ AFFIRMATION SYSTEM ============
    function loadAffirmations() {
        // Default affirmations - you can expand this list
        dailyAffirmations = [
            { text: "Today is a new opportunity to make progress toward your goals.", author: "" },
            { text: "You are capable of amazing things. Believe in yourself today.", author: "" },
            { text: "Small, consistent actions lead to big results. Keep going!", author: "" },
            { text: "Your focus determines your reality. Choose to focus on what matters.", author: "Star Wars" },
            { text: "The secret of getting ahead is getting started.", author: "Mark Twain" },
            { text: "You don't have to be great to start, but you have to start to be great.", author: "Zig Ziglar" },
            { text: "Productivity is never an accident. It is always the result of commitment to excellence.", author: "Paul J. Meyer" },
            { text: "The way to get started is to quit talking and begin doing.", author: "Walt Disney" },
            { text: "Your future is created by what you do today, not tomorrow.", author: "Robert Kiyosaki" },
            { text: "The only limit to our realization of tomorrow will be our doubts of today.", author: "Franklin D. Roosevelt" }
        ];
        
        // Get today's date as a seed for consistent daily affirmation
        const today = new Date();
        const seed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
        currentAffirmationIndex = seed % dailyAffirmations.length;
        
        showAffirmation();
    }

    function showAffirmation() {
        const affirmation = dailyAffirmations[currentAffirmationIndex];
        document.getElementById('affirmationText').textContent = affirmation.text;
        document.getElementById('affirmationAuthor').textContent = affirmation.author ? `- ${affirmation.author}` : '';
    }

    function nextAffirmation() {
        currentAffirmationIndex = (currentAffirmationIndex + 1) % dailyAffirmations.length;
        showAffirmation();
    }

    // ============ PWA FUNCTIONS ============
    function isRunningStandalone() {
        return window.matchMedia('(display-mode: standalone)').matches || 
               window.navigator.standalone === true;
    }

    function checkOnlineStatus() {
        if (!navigator.onLine) {
            showOfflineUI();
        }
    }

    function showOfflineUI() {
        if (offlineMessage) {
            offlineMessage.style.display = 'block';
        }
    }

    function hideOfflineUI() {
        if (offlineMessage) {
            offlineMessage.style.display = 'none';
        }
    }

    function showUpdateNotification() {
        if (confirm('A new version is available! Reload to update?')) {
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'SKIP_WAITING'
                });
            }
            window.location.reload();
        }
    }

    function manualInstall() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    installButton.style.display = 'none';
                }
                deferredPrompt = null;
            });
        } else {
            if (isRunningStandalone()) {
                alert('App is already installed!');
            } else {
                alert('Install option should appear automatically. Try refreshing the page.');
            }
        }
    }

    function showNotification(title, body) {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(title, {
                body: body,
                icon: 'icons/icon-192.png',
                badge: 'icons/icon-192.png'
            });
        }
    }

    function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    }

    // ============ TIMER FUNCTIONS ============
    function startTimer(taskId, taskName, alarmTime) {
        activeTimers[taskId] = {
            taskName: taskName,
            alarmTime: alarmTime,
            completed: false
        };
        saveData();
    }

    function checkTimers() {
        const now = new Date();
        let nextTimer = null;
        let nextTimeDiff = Infinity;

        currentTimeElem.textContent = `Current Time: ${formatTime(now)}`;

        for (const taskId in activeTimers) {
            const timer = activeTimers[taskId];
            const timeDiff = timer.alarmTime - now;

            if (timeDiff <= 0 && !timer.completed) {
                triggerTimer(taskId);
            } else if (timeDiff > 0 && timeDiff < nextTimeDiff) {
                nextTimer = timer;
                nextTimeDiff = timeDiff;
            }
        }

        if (nextTimer) {
            const hours = Math.floor(nextTimeDiff / (1000 * 60 * 60));
            const minutes = Math.floor((nextTimeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((nextTimeDiff % (1000 * 60)) / 1000);
            timerDisplay.textContent = `Next: "${nextTimer.taskName}" in ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        } else {
            timerDisplay.textContent = "No active timers";
        }
    }

    function triggerTimer(taskId) {
        const timer = activeTimers[taskId];
        if (timer && !timer.completed) {
            timer.completed = true;
            timerMessage.textContent = `Time's up for: ${timer.taskName}!`;
            timerModal.style.display = 'flex';
            
            playAlertSound();
            showNotification('‚è∞ Timer Alert', `Time's up for: ${timer.taskName}!`);
            
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
            
            saveData();
        }
    }

    function playAlertSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } catch (e) {
            console.log('Audio not supported:', e);
        }
    }

    function snoozeTimer() {
        for (const taskId in activeTimers) {
            const timer = activeTimers[taskId];
            if (timer.completed) {
                timer.alarmTime = new Date(Date.now() + 5 * 60 * 1000);
                timer.completed = false;
                break;
            }
        }
        timerModal.style.display = 'none';
        saveData();
    }

    function dismissTimer() {
        timerModal.style.display = 'none';
    }

    // ============ TASK MANAGEMENT ============
    function saveData() {
        appData.routine = routine;
        appData.notes = notes;
        appData.totalRewards = totalRewardsValue;
        appData.weeklyRewards = weeklyRewardsValue;
        appData.timers = activeTimers;
        appData.currentStreak = currentStreak;
        appData.lastCompletionDate = appData.lastCompletionDate;
        appData.rewardType = rewardType;
        appData.rewardUnit = rewardUnit;
        appData.currency = currency;
        appData.customRewardName = customRewardName;
        localStorage.setItem("taskpilotData", JSON.stringify(appData));
    }

    function switchDay(day) {
        currentDay = day;
        tabs.forEach(tab => {
            tab.classList.toggle('active', tab.dataset.day === day);
        });
        loadTasks();
        updateStats();
    }

    function loadTasks() {
        taskList.innerHTML = '';
        
        if (routine[currentDay].length === 0) {
            taskList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="far fa-calendar-plus"></i>
                    </div>
                    <h3>No tasks for ${currentDay}</h3>
                    <p>Add a task to get started!</p>
                </div>
            `;
            return;
        }
        
        routine[currentDay].forEach((task, index) => {
            const taskId = `${currentDay}-${index}`;
            const hasTimer = activeTimers[taskId] && !activeTimers[taskId].completed;
            const taskItem = document.createElement('li');
            taskItem.className = `task-item ${task.done ? 'done' : ''} ${hasTimer ? 'has-timer' : ''} slide-in`;
            taskItem.innerHTML = `
                <div class="task-checkbox ${task.done ? 'checked' : ''}" data-index="${index}"></div>
                <div class="task-content">
                    <span class="task-time">${task.time} ${task.date ? `on ${task.date}` : ''}</span>
                    <span class="task-text ${task.done ? 'done' : ''}">${task.text}</span>
                    ${hasTimer ? `<div class="task-timer"><i class="fas fa-clock"></i> Timer set</div>` : ''}
                </div>
                <div class="task-actions">
                    <button class="action-btn timer-btn ${hasTimer ? 'active' : ''}" data-index="${index}">
                        <i class="fas fa-clock"></i>
                    </button>
                    <button class="action-btn edit-btn" data-index="${index}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete-btn" data-index="${index}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            taskList.appendChild(taskItem);
        });
        
        attachTaskEventListeners();
    }

    function attachTaskEventListeners() {
        document.querySelectorAll('.task-checkbox').forEach(checkbox => {
            checkbox.addEventListener('click', function() {
                toggleTask(parseInt(this.dataset.index));
            });
        });
        
        document.querySelectorAll('.timer-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                setTimer(parseInt(this.dataset.index));
            });
        });
        
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                editTask(parseInt(this.dataset.index));
            });
        });
        
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                deleteTask(parseInt(this.dataset.index));
            });
        });
    }

    function setTimer(index) {
        const task = routine[currentDay][index];
        const taskId = `${currentDay}-${index}`;
        
        if (activeTimers[taskId] && !activeTimers[taskId].completed) {
            delete activeTimers[taskId];
        } else {
            const alarmDate = task.date ? new Date(task.date) : new Date();
            const [hours, minutes] = task.time.split(':');
            alarmDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            if (alarmDate < new Date()) {
                alarmDate.setDate(alarmDate.getDate() + 1);
            }
            
            startTimer(taskId, task.text, alarmDate);
        }
        
        saveData();
        loadTasks();
    }

    function addTask() {
        const date = taskDateInput.value;
        const time = taskTimeInput.value;
        const text = taskTextInput.value.trim();

        if (time && text) {
            routine[currentDay].push({ date, time, text, done: false });
            saveData();
            loadTasks();
            updateStats();
            
            taskTimeInput.value = '';
            taskTextInput.value = '';
            taskTextInput.focus();
        } else {
            alert("Please enter both time and task!");
        }
    }

    function deleteTask(index) {
        if (confirm("Are you sure you want to delete this task?")) {
            const taskId = `${currentDay}-${index}`;
            
            if (routine[currentDay][index].done) {
                weeklyRewardsValue--;
                totalRewardsValue--;
            }
            
            if (activeTimers[taskId]) {
                delete activeTimers[taskId];
            }
            
            routine[currentDay].splice(index, 1);
            saveData();
            loadTasks();
            updateStats();
            updateRewardDisplay();
        }
    }

    function editTask(index) {
        const task = routine[currentDay][index];
        const newDate = prompt("Enter new date (YYYY-MM-DD):", task.date || new Date().toISOString().split('T')[0]);
        const newTime = prompt("Enter new time:", task.time);
        const newText = prompt("Enter new task:", task.text);

        if (newTime && newText) {
            routine[currentDay][index] = { ...task, date: newDate, time: newTime, text: newText };
            
            const taskId = `${currentDay}-${index}`;
            if (activeTimers[taskId]) {
                delete activeTimers[taskId];
            }
            
            saveData();
            loadTasks();
        }
    }

    function toggleTask(index) {
        const wasDone = routine[currentDay][index].done;
        routine[currentDay][index].done = !wasDone;

        if (!wasDone) {
            // Task completed - add rewards
            weeklyRewardsValue++;
            totalRewardsValue++;
        } else {
            // Task uncompleted - remove rewards (with minimum of 0)
            weeklyRewardsValue = Math.max(0, weeklyRewardsValue - 1);
            totalRewardsValue = Math.max(0, totalRewardsValue - 1);
            
            // Show warning if rewards go too low
            if (totalRewardsValue < 3) {
                showNotification('üí° Low Rewards', 'Complete tasks to earn more rewards!');
            }
        }

        saveData();
        loadTasks();
        updateStats();
        updateRewardDisplay();
        checkDailyCompletion(); // Update streak when tasks are toggled
    }

    // ============ NOTES MANAGEMENT ============
    function loadNotes() {
        notesContainer.innerHTML = '';
        
        if (notes.length === 0) {
            notesContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="far fa-sticky-note"></i>
                    </div>
                    <h3>No notes yet</h3>
                    <p>Add your first note to get started!</p>
                </div>
            `;
            return;
        }
        
        notes.forEach((note, index) => {
            const noteCard = document.createElement('div');
            noteCard.className = 'note-card slide-in';
            noteCard.innerHTML = `
                <div class="note-header">
                    <div class="note-title">${note.title}</div>
                    <div class="note-date">${formatNoteDate(new Date(note.date))}</div>
                </div>
                <div class="note-content">${note.content}</div>
                <div class="note-actions">
                    <button class="note-btn edit-note-btn" data-index="${index}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="note-btn delete-note-btn" data-index="${index}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            notesContainer.appendChild(noteCard);
        });
        
        attachNoteEventListeners();
    }

    function attachNoteEventListeners() {
        document.querySelectorAll('.edit-note-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                editNote(parseInt(this.dataset.index));
            });
        });
        
        document.querySelectorAll('.delete-note-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                deleteNote(parseInt(this.dataset.index));
            });
        });
    }

    function openNoteModal(isEditing = false, noteIndex = null) {
        if (isEditing && noteIndex !== null) {
            noteModalTitle.textContent = 'Edit Note';
            noteTitleInput.value = notes[noteIndex].title;
            noteContentInput.value = notes[noteIndex].content;
            editingNoteId = noteIndex;
        } else {
            noteModalTitle.textContent = 'Add New Note';
            noteTitleInput.value = '';
            noteContentInput.value = '';
            editingNoteId = null;
        }
        noteModal.style.display = 'flex';
    }

    function closeNoteModal() {
        noteModal.style.display = 'none';
        editingNoteId = null;
    }

    function saveNote() {
        const title = noteTitleInput.value.trim();
        const content = noteContentInput.value.trim();
        
        if (title && content) {
            if (editingNoteId !== null) {
                // Update existing note
                notes[editingNoteId] = {
                    title,
                    content,
                    date: notes[editingNoteId].date // Keep original date
                };
            } else {
                // Add new note
                notes.push({
                    title,
                    content,
                    date: new Date().toISOString()
                });
            }
            
            saveData();
            loadNotes();
            closeNoteModal();
        } else {
            alert("Please enter both title and content for your note!");
        }
    }

    function editNote(index) {
        openNoteModal(true, index);
    }

    function deleteNote(index) {
        if (confirm("Are you sure you want to delete this note?")) {
            notes.splice(index, 1);
            saveData();
            loadNotes();
        }
    }

    // ============ STATS AND UI UPDATES ============
    function updateStats() {
        let completedTasks = 0;
        let totalTasks = 0;
        
        Object.keys(routine).forEach(day => {
            routine[day].forEach(task => {
                totalTasks++;
                if (task.done) completedTasks++;
            });
        });
        
        if (totalTasks > 0) {
            const progressPercentage = (completedTasks / totalTasks) * 100;
            progressFill.style.width = `${progressPercentage}%`;
        } else {
            progressFill.style.width = '0%';
        }
        
        weeklyTasksElem.textContent = totalTasks;
        completedTasksElem.textContent = completedTasks;
        completionRateElem.textContent = totalTasks > 0 ? `${Math.round((completedTasks / totalTasks) * 100)}%` : '0%';
    }

    function updateWeekInfo() {
        const nextReset = getNextResetDate();
        currentWeekElem.textContent = `Week ${currentWeek} of ${new Date().getFullYear()}`;
        nextResetElem.textContent = formatDate(nextReset);
    }

    // ============ EVENT LISTENERS ============
    addTaskBtn.addEventListener('click', addTask);
    
    taskTextInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') addTask();
    });

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            switchDay(this.dataset.day);
        });
    });

    snoozeTimerBtn.addEventListener('click', snoozeTimer);
    dismissTimerBtn.addEventListener('click', dismissTimer);

    // Notes event listeners
    addNoteBtn.addEventListener('click', () => openNoteModal(false));
    saveNoteBtn.addEventListener('click', saveNote);
    cancelNoteBtn.addEventListener('click', closeNoteModal);

    // Reward event listeners
    rewardSettings.addEventListener('click', openRewardModal);
    saveRewardBtn.addEventListener('click', saveRewardPreferences);
    cancelRewardBtn.addEventListener('click', closeRewardModal);
    
    // Reward option selection
    rewardOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Remove selection from all options
            rewardOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Add selection to clicked option
            this.classList.add('selected');
            
            // Show/hide additional inputs
            if (this.dataset.type === "money") {
                currencySelect.style.display = 'block';
                customRewardInput.style.display = 'none';
            } else if (this.dataset.type === "custom") {
                customRewardInput.style.display = 'block';
                currencySelect.style.display = 'none';
            } else {
                currencySelect.style.display = 'none';
                customRewardInput.style.display = 'none';
            }
        });
    });

    // PWA Event Listeners
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if (installButton) installButton.style.display = 'flex';
    });

    if (installButton) {
        installButton.addEventListener('click', manualInstall);
    }

    window.addEventListener('online', hideOfflineUI);
    window.addEventListener('offline', showOfflineUI);

    // ============ INITIALIZATION ============
    window.addEventListener('DOMContentLoaded', () => {
        // Set default date
        taskDateInput.valueAsDate = new Date();

        // Load saved data
        if (appData.timers) {
            activeTimers = appData.timers;
            for (const taskId in activeTimers) {
                if (typeof activeTimers[taskId].alarmTime === 'string') {
                    activeTimers[taskId].alarmTime = new Date(activeTimers[taskId].alarmTime);
                }
            }
        }

        currentStreak = appData.currentStreak || 0;

        // Initialize app
        switchDay("Monday");
        updateWeekInfo();
        updateStats();
        updateRewardDisplay();
        loadNotes();
        changeBackground();
        checkOnlineStatus();
        calculateStreak();
        loadAffirmations();
        checkDailyCompletion();

        // Start intervals
        setInterval(() => {
            checkTimers();
        }, 1000);

        // Refresh affirmations 
        document.getElementById('refreshAffirmation').addEventListener('click', nextAffirmation);

        // Force install button after 5 seconds
        setTimeout(() => {
            if (installButton && !isRunningStandalone()) {
                installButton.style.display = 'flex';
            }
        }, 5000);

        // Request notification permission on first click
        document.addEventListener('click', requestNotificationPermission, { once: true });

        // Enhanced Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    // Register service worker
    navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
      .then(function(registration) {
        console.log('ServiceWorker registration successful with scope: ', registration.scope);
        
        // Check for updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('New service worker found...');
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('New content is available; please refresh.');
              // Show update notification to user
              showUpdateNotification();
            }
          });
        });
        
        // Set up periodic sync for weekly data
        if ('periodicSync' in registration) {
          registration.periodicSync.register('weekly-refresh', {
            minInterval: 7 * 24 * 60 * 60 * 1000 // 7 days
          }).then(() => {
            console.log('Periodic sync registered');
          }).catch((error) => {
            console.log('Periodic sync could not be registered', error);
          });
        }
        
        // Set up background sync for offline data
        if ('sync' in registration) {
          // This will be triggered when the app requests a sync
        }
      })
      .catch(function(error) {
        console.log('ServiceWorker registration failed: ', error);
      });
      
    // Listen for controlled page updates
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      window.location.reload();
    });
  });
  
  // Function to show update notification
  function showUpdateNotification() {
    if (confirm('A new version of TaskPilot is available. Would you like to update now?')) {
      window.location.reload();
    }
  }
  
  // Request notification permission
  function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          console.log('Notification permission granted');
        }
      });
    }
  }
  
  // Request permission on user interaction
  document.addEventListener('click', requestNotificationPermission, { once: true });
}

// Offline detection
window.addEventListener('online', function() {
  document.getElementById('offlineMessage').style.display = 'none';
  console.log('App is online');
  // Trigger background sync when coming online
  if ('serviceWorker' in navigator && 'sync' in navigator.serviceWorker) {
    navigator.serviceWorker.ready.then(registration => {
      registration.sync.register('sync-tasks');
    });
  }
});

window.addEventListener('offline', function() {
  document.getElementById('offlineMessage').style.display = 'block';
  console.log('App is offline');
});

// Function to send message to service worker
function sendMessageToSW(message) {
  if (navigator.serviceWorker && navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage(message);
  }
}

// Example: Cache current tasks
function cacheCurrentTasks(tasks) {
  sendMessageToSW({
    type: 'CACHE_TASKS',
    tasks: tasks
  });
}

// Example: Register for background sync
function registerSync() {
  sendMessageToSW({
    type: 'REGISTER_SYNC'
  });
}

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (timerInterval) clearInterval(timerInterval);
        });
    });
  </script>
</body>
</html>